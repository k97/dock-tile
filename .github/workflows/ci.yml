name: CI

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - 'website/**'
      - 'vercel.json'
      - '*.md'
  pull_request:
    branches: [main]
    paths-ignore:
      - 'website/**'
      - 'vercel.json'
      - '*.md'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  SCHEME: DockTile
  PROJECT: DockTile.xcodeproj

jobs:
  build-and-test:
    name: Build & Test
    # Use macos-latest to get the newest available runner (currently macos-15, will auto-update to macos-26 when available)
    # Fallback: Use macos-15 if macos-latest isn't sufficient
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: List available Xcode versions
        run: ls -la /Applications/ | grep Xcode || true

      - name: Select Xcode
        run: |
          # Try to use Xcode 26.2 (matches local dev environment)
          # Fall back to latest available Xcode 16.x if not found
          if [ -d "/Applications/Xcode_26.2.app" ]; then
            echo "✅ Using Xcode 26.2 (matches local environment)"
            sudo xcode-select -s /Applications/Xcode_26.2.app/Contents/Developer
          elif [ -d "/Applications/Xcode_26.app" ]; then
            echo "✅ Using Xcode 26.0"
            sudo xcode-select -s /Applications/Xcode_26.app/Contents/Developer
          elif [ -d "/Applications/Xcode_16.2.app" ]; then
            echo "⚠️  Using Xcode 16.2 (fallback)"
            sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer
          elif [ -d "/Applications/Xcode_16.1.app" ]; then
            echo "⚠️  Using Xcode 16.1 (fallback)"
            sudo xcode-select -s /Applications/Xcode_16.1.app/Contents/Developer
          elif [ -d "/Applications/Xcode_16.app" ]; then
            echo "⚠️  Using Xcode 16.0 (fallback)"
            sudo xcode-select -s /Applications/Xcode_16.app/Contents/Developer
          else
            echo "❌ No suitable Xcode found, using system default"
          fi

      - name: Show Xcode and SDK info
        run: |
          xcodebuild -version
          xcrun --show-sdk-path
          xcodebuild -showsdks

      - name: Build Debug
        run: |
          set -o pipefail
          xcodebuild \
            -project $PROJECT \
            -scheme $SCHEME \
            -configuration Debug \
            -destination 'platform=macOS' \
            -derivedDataPath ./build \
            CODE_SIGNING_ALLOWED='NO' \
            ONLY_ACTIVE_ARCH=NO \
            build 2>&1 | tee build.log | xcpretty --color || (cat build.log && exit 1)

      - name: Verify app bundle
        run: |
          echo "=== Build Products Directory ==="
          find ./build/Build/Products -type d -name "*.app" || echo "No .app found"

          # Debug builds produce "Dock Tile Dev.app", Release builds produce "Dock Tile.app"
          APP_PATH=$(find ./build/Build/Products -name "Dock Tile*.app" -type d | head -1)

          if [ -z "$APP_PATH" ]; then
            echo "❌ App bundle not found!"
            echo "Build directory contents:"
            ls -laR ./build/Build/Products/ || true
            exit 1
          fi

          echo "✅ Found app at: $APP_PATH"
          echo "=== Contents ==="
          ls -la "$APP_PATH/Contents/"
          ls -la "$APP_PATH/Contents/MacOS/" || echo "MacOS folder empty or missing"

          # Check for any executable in MacOS folder
          if ls "$APP_PATH/Contents/MacOS/"* 1> /dev/null 2>&1; then
            echo "✅ Executable found"
            ls -la "$APP_PATH/Contents/MacOS/"
          else
            echo "❌ No executable found in MacOS folder"
            exit 1
          fi

      - name: Run Unit Tests
        run: |
          set -o pipefail
          xcodebuild test \
            -project $PROJECT \
            -scheme $SCHEME \
            -configuration Debug \
            -destination 'platform=macOS' \
            -derivedDataPath ./build \
            -enableCodeCoverage YES \
            -only-testing:DockTileTests \
            CODE_SIGNING_ALLOWED='NO' \
            ENABLE_TESTABILITY=YES \
            2>&1 | tee test.log | xcpretty --color || (cat test.log && exit 1)

      - name: Upload Build Log
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            build.log
            test.log

      - name: Upload build artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: DockTile-Debug
          path: ./build/Build/Products/Debug/Dock Tile*.app
          retention-days: 7
